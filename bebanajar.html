<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portal Jadwal Guru SMAPANMU</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #1e40af;
            --accent: #3b82f6;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: radial-gradient(circle at top right, #f8fafc, #eff6ff);
            -webkit-tap-highlight-color: transparent;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s cubic-bezier(0.76, 0, 0.24, 1) infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Responsivitas Kolom Sticky */
        .sticky-col { 
            position: sticky; 
            left: 0; 
            background: #ffffff; 
            z-index: 20; 
            border-right: 2px solid #f1f5f9 !important; 
        }

        .sticky-name-col {
            position: sticky;
            left: 48px; /* Menyesuaikan lebar kolom No */
            z-index: 15;
            background: white;
            border-right: 2px solid #e2e8f0 !important;
            min-width: 150px;
        }

        .header-sticky { 
            position: sticky; 
            top: 0; 
            z-index: 40; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .table-row-hover:hover {
            background-color: #f8faff !important;
        }

        .btn-gradient {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transition: all 0.3s ease;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen text-slate-900 pb-12">

    <!-- Login Overlay -->
    <div id="loginOverlay" class="fixed inset-0 z-[100] bg-slate-900/40 backdrop-blur-xl flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-500">
            <div class="p-8 md:p-10 text-center bg-gradient-to-br from-blue-700 to-blue-900 text-white flex flex-col items-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                    <svg width="100%" height="100%"><pattern id="pattern" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse"><circle cx="2" cy="2" r="1" fill="white"/></pattern><rect width="100%" height="100%" fill="url(#pattern)"/></svg>
                </div>
                <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi2iWi5Y8Dt91tWD8v24sfYGNL9jWxhRp2epChSaav1QQ3CZWhRb753XFGQOsT9u82kEEQAVkdZVKbbQ2I4Tkhkr9h00KJkaYnZK3jI-HPuUqcO6A3UXFZ9l43qF0sajMqs5asm2ttdvjYUxsxswINcBf7bN7gcNooq-R0KVSFwirkTeTICe6cTnGlyPmQ/s1600/logo%20mapan.png" 
                     alt="Logo Sekolah" 
                     class="h-24 md:h-32 w-auto mb-4 md:mb-6 drop-shadow-2xl relative z-10"
                     onerror="this.style.display='none'">
                <h2 class="text-2xl md:text-3xl font-extrabold tracking-tighter relative z-10">PORTAL JADWAL</h2>
                <p class="text-blue-100/80 text-[10px] md:text-xs font-medium mt-2 uppercase tracking-widest relative z-10">SMAPANMU Portal</p>
            </div>
            <div class="p-6 md:p-10 bg-white">
                <div class="space-y-4 md:space-y-6">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 px-1">Hak Akses</label>
                        <select id="loginRole" class="w-full p-3 md:p-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none transition-all appearance-none cursor-pointer font-medium text-sm">
                            <option value="guru">üë®‚Äçüè´ Guru (Personal)</option>
                            <option value="admin">üîí Admin (Pengelola)</option>
                            <option value="guest">üåç Tamu (Publik)</option>
                        </select>
                    </div>
                    <div id="guruInputGroup">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 px-1">Nama Lengkap</label>
                        <input type="text" id="loginUsername" placeholder="Masukkan nama..." class="w-full p-3 md:p-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none transition-all font-medium text-sm">
                        <p class="text-[9px] text-slate-400 mt-2 italic">*Sesuai data sistem.</p>
                    </div>
                    <button id="btnEnter" class="w-full btn-gradient text-white py-3 md:py-4 rounded-2xl font-bold shadow-lg shadow-blue-200 text-base md:text-lg">
                        Masuk Sekarang
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden max-w-7xl mx-auto px-4 sm:px-6 py-4 md:py-8">
        <!-- App Header -->
        <div class="mb-6 md:mb-8 flex flex-col lg:flex-row lg:items-center justify-between gap-4 md:gap-6 glass-card p-4 md:p-6 rounded-[1.5rem] md:rounded-[2rem] shadow-sm border border-slate-200">
            <div class="flex items-center gap-4 md:gap-5">
                <div class="bg-white p-1.5 rounded-xl shadow-sm border border-slate-100">
                    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi2iWi5Y8Dt91tWD8v24sfYGNL9jWxhRp2epChSaav1QQ3CZWhRb753XFGQOsT9u82kEEQAVkdZVKbbQ2I4Tkhkr9h00KJkaYnZK3jI-HPuUqcO6A3UXFZ9l43qF0sajMqs5asm2ttdvjYUxsxswINcBf7bN7gcNooq-R0KVSFwirkTeTICe6cTnGlyPmQ/s1600/logo%20mapan.png" 
                         alt="Logo" 
                         class="h-10 md:h-14 w-auto object-contain">
                </div>
                <div>
                    <h1 id="appTitle" class="text-lg md:text-2xl font-extrabold text-slate-900 tracking-tight leading-tight">Dashboard Jadwal</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="inline-block w-2 h-2 rounded-full bg-green-500"></span>
                        <p id="userStatus" class="text-[10px] md:text-xs text-slate-500 font-semibold uppercase tracking-wider"></p>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-2 md:gap-3">
                <div id="adminTools" class="hidden">
                    <a href="https://docs.google.com/spreadsheets/d/1t3WNhu2tCaHWPTNcyOC7kupXNNdE6pH30QRAqyr1L8s/edit" target="_blank" class="bg-slate-900 text-white px-3 md:px-5 py-2 md:py-3 rounded-xl md:rounded-2xl text-[10px] md:text-sm font-bold flex items-center gap-2 hover:bg-slate-800 transition-all shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 md:h-4 w-3 md:w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        <span class="hidden sm:inline">Edit Data Utama</span>
                        <span class="sm:hidden text-xs">Edit</span>
                    </a>
                </div>
                <button id="logoutBtn" class="flex items-center gap-2 bg-red-50 text-red-600 px-4 py-2 md:py-3 rounded-xl md:rounded-2xl text-[10px] md:text-sm font-bold hover:bg-red-100 transition-all">
                    <span>Keluar</span>
                </button>
            </div>
        </div>

        <!-- Controls -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 md:mb-8">
            <div class="md:col-span-3 relative glass-card p-1 rounded-xl md:rounded-2xl shadow-sm border border-slate-200">
                <input type="text" id="searchInput" placeholder="Cari hari, jam, atau mapel..." class="w-full pl-10 md:pl-12 pr-4 py-3 md:py-4 bg-transparent outline-none font-medium text-sm md:text-base text-slate-600">
                <div class="absolute left-3 md:left-4 top-1/2 -translate-y-1/2 text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 md:h-6 w-5 md:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
            <div class="bg-blue-600 p-3 md:p-4 rounded-xl md:rounded-2xl shadow-lg flex items-center justify-between px-6 text-white">
                <div class="flex flex-col">
                    <span class="text-[9px] font-bold uppercase opacity-70 tracking-tighter">Sesi</span>
                    <span id="dataCount" class="text-xl md:text-2xl font-black leading-none mt-1">--</span>
                </div>
                <div class="opacity-20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 md:h-10 w-8 md:w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Table Container -->
        <div class="bg-white rounded-[1.5rem] md:rounded-[2rem] shadow-xl border border-slate-200 overflow-hidden relative">
            <div class="overflow-x-auto max-h-[65vh] md:max-h-[70vh]">
                <table class="w-full text-left border-collapse min-w-[1200px] md:min-w-[2000px]">
                    <thead id="tableHead" class="bg-slate-900 text-white text-[9px] md:text-[11px] font-bold uppercase tracking-widest header-sticky">
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100 text-[11px] md:text-[13px] text-slate-600">
                    </tbody>
                </table>
            </div>
            
            <div id="loadingStatus" class="absolute inset-0 bg-white/80 backdrop-blur-md flex flex-col items-center justify-center z-50">
                <div class="loader mb-4"></div>
                <p class="font-bold text-slate-700 text-sm">Menyinkronkan data...</p>
            </div>

            <div id="emptyState" class="hidden py-12 md:py-20 flex flex-col items-center justify-center text-slate-400">
                <p class="font-semibold text-sm">Data tidak ditemukan</p>
            </div>
        </div>
    </div>

    <script>
        const SHEET_ID = '1t3WNhu2tCaHWPTNcyOC7kupXNNdE6pH30QRAqyr1L8s';
        const GID = '1034481041';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

        let masterData = [];
        let headers = [];
        let currentUser = { role: null, name: null };

        document.getElementById('loginRole').addEventListener('change', (e) => {
            document.getElementById('guruInputGroup').style.display = e.target.value === 'guru' ? 'block' : 'none';
        });

        document.getElementById('btnEnter').addEventListener('click', () => {
            const role = document.getElementById('loginRole').value;
            const name = document.getElementById('loginUsername').value.trim();
            if (role === 'guru' && !name) return alert('Silakan masukkan nama!');
            currentUser = { role, name };
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            updateHeaderUI();
            fetchData();
        });

        document.getElementById('logoutBtn').addEventListener('click', () => location.reload());

        function updateHeaderUI() {
            const title = document.getElementById('appTitle');
            const status = document.getElementById('userStatus');
            const adminTools = document.getElementById('adminTools');
            if (currentUser.role === 'admin') {
                title.innerHTML = "Sistem <span class='text-blue-600'>Admin</span>";
                status.textContent = "Pengelola";
                adminTools.classList.remove('hidden');
            } else if (currentUser.role === 'guru') {
                title.innerHTML = `Halo, <span class='text-blue-600'>${currentUser.name}</span>`;
                status.textContent = "Mode Personal";
            } else {
                title.innerHTML = "Jadwal <span class='text-blue-600'>Publik</span>";
                status.textContent = "Mode Tamu";
            }
        }

        async function fetchData() {
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                processData(csvText);
                document.getElementById('loadingStatus').classList.add('hidden');
            } catch (error) { alert('Gagal memuat data'); }
        }

        function processData(csv) {
            const lines = csv.split(/\r?\n/);
            const r8 = parseCSV(lines[7]), r9 = parseCSV(lines[8]);
            headers = [];
            for (let i = 1; i <= 22; i++) headers.push({ index: i, label: (r8[i] || '').trim() + ' ' + (r9[i] || '').trim() });
            masterData = lines.slice(9).map(l => {
                const cols = parseCSV(l);
                if (!cols[1] && !cols[2]) return null;
                let obj = {};
                headers.forEach(h => obj[`c${h.index}`] = cols[h.index] || '');
                return obj;
            }).filter(x => x !== null);
            applyFilterAndRender();
        }

        function parseCSV(row) {
            if (!row) return [];
            const res = [];
            let curr = '', q = false;
            for (let c of row) {
                if (c === '"') q = !q;
                else if (c === ',' && !q) { res.push(curr.trim().replace(/^"|"$/g, '')); curr = ''; }
                else curr += c;
            }
            res.push(curr.trim().replace(/^"|"$/g, ''));
            return res;
        }

        function applyFilterAndRender() {
            let filtered = masterData;
            if (currentUser.role === 'guru') {
                filtered = masterData.filter(item => item.c2.toLowerCase().includes(currentUser.name.toLowerCase()));
            }
            const term = document.getElementById('searchInput').value.toLowerCase();
            if (term) {
                filtered = filtered.filter(item => Object.values(item).some(v => v.toLowerCase().includes(term)));
            }
            document.getElementById('emptyState').classList.toggle('hidden', filtered.length > 0);
            renderTable(filtered);
        }

        function renderTable(data) {
            const head = document.getElementById('tableHead');
            const body = document.getElementById('tableBody');
            
            head.innerHTML = `<tr>
                <th class="px-3 py-4 text-center sticky-col bg-slate-900 border-r border-slate-800 w-12">NO</th>
                ${headers.map(h => `<th class="px-4 py-4 border-r border-slate-800 ${h.index === 2 ? 'sticky-name-col bg-slate-900 shadow-md' : ''}">${h.label}</th>`).join('')}
            </tr>`;

            body.innerHTML = data.map((row, i) => `
                <tr class="table-row-hover">
                    <td class="px-3 py-3 text-center sticky-col font-bold bg-white border-r border-slate-100">${i+1}</td>
                    ${headers.map(h => {
                        const isName = h.index === 2;
                        return `<td class="px-4 py-3 border-r border-slate-50 ${isName ? 'sticky-name-col font-bold text-blue-900' : ''}">${row[`c${h.index}`] || '-'}</td>`;
                    }).join('')}
                </tr>
            `).join('');
            document.getElementById('dataCount').textContent = data.length;
        }

        document.getElementById('searchInput').addEventListener('input', applyFilterAndRender);
        setInterval(fetchData, 120000);
    </script>
</body>
</html>
