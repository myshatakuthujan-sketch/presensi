<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEM PRESENSI BIOMETRIK SMAPANMU - HYBRID</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <style>
        canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
            pointer-events: none;
            z-index: 10;
        }
        .video-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 4 / 3;
            background: #000;
            border-radius: 32px;
            overflow: hidden;
            box-shadow: 0 30px 60px -12px rgba(0,0,0,0.6);
            border: 4px solid #fff;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        .mode-btn.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4);
        }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; padding: 0; margin: 0; }
            @page { margin: 1cm; }
        }

        #settingsModal { backdrop-filter: blur(8px); }
        .offline-badge { display: none; }
        body.is-offline .offline-badge { display: flex; }
    </style>
</head>
<body class="bg-[#f0f4f8] min-h-screen font-sans pb-20">

    <div class="max-w-7xl mx-auto px-4 py-8 no-print">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center md:items-end mb-8 gap-4">
            <div>
                <div class="flex items-center gap-3">
                    <h1 class="text-3xl font-[1000] text-slate-900 tracking-tighter italic uppercase">
                        ADMIN <span class="text-indigo-600">SMAPANMU</span>
                    </h1>
                    <div class="offline-badge items-center gap-1.5 bg-amber-100 text-amber-700 px-3 py-1 rounded-full text-[9px] font-black uppercase">
                        <div class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></div>
                        Mode Offline
                    </div>
                </div>
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.3em] mt-1 italic">
                    E-Presensi Akuntabel v12.3 (Data Terproteksi)
                </p>
            </div>
            
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <button onclick="window.toggleSettings()" class="bg-white p-3 rounded-2xl shadow-sm border border-slate-200 hover:bg-slate-50 transition-all">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066-1.543.94-3.31-.826-2.37-2.37 1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </button>

                <div class="flex bg-white p-1.5 rounded-2xl shadow-sm border border-slate-200">
                    <button onclick="window.changeMode('harian')" id="btn-harian" class="mode-btn active px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">Guru</button>
                    <button onclick="window.changeMode('rapat')" id="btn-rapat" class="mode-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">Rapat</button>
                    <button onclick="window.changeMode('tamu')" id="btn-tamu" class="mode-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">Tamu</button>
                </div>
            </div>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-12">
            <div class="lg:col-span-7">
                <div class="video-wrapper">
                    <video id="video" autoplay muted playsinline></video>
                    <div id="loader" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-950 z-50">
                        <div class="w-16 h-16 border-[6px] border-indigo-600 border-t-transparent rounded-full animate-spin mb-6"></div>
                        <p class="text-[11px] font-black text-white tracking-[0.5em] uppercase text-center">Inisialisasi Keamanan Biometrik...</p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-5 space-y-6">
                <div id="statusCard" class="bg-white p-8 rounded-[3rem] shadow-2xl border border-slate-100 transition-all">
                    <h2 id="statusTitle" class="text-2xl font-[1000] text-slate-900 leading-none italic uppercase mb-2">SIAP VERIFIKASI</h2>
                    <p id="statusDesc" class="text-[11px] text-slate-400 font-bold uppercase tracking-wider">Arahkan Wajah & Kedipkan Mata</p>
                </div>

                <div class="bg-slate-900 p-8 rounded-[3rem] shadow-xl">
                    <h3 class="text-[10px] font-black text-indigo-400 uppercase tracking-widest italic mb-6">Registrasi Wajah Baru</h3>
                    <div class="space-y-4">
                        <input type="text" id="nameInput" placeholder="NAMA LENGKAP" class="w-full px-6 py-4 bg-white/5 border-2 border-transparent rounded-2xl outline-none text-white text-[11px] font-black uppercase tracking-widest focus:border-indigo-500">
                        <input type="text" id="jobInput" placeholder="JABATAN / NIP" class="w-full px-6 py-4 bg-white/5 border-2 border-transparent rounded-2xl outline-none text-white text-[11px] font-black uppercase tracking-widest focus:border-indigo-500">
                        <button id="startRegBtn" class="w-full bg-indigo-600 text-white font-[1000] py-4 rounded-2xl text-[11px] uppercase tracking-widest shadow-lg shadow-indigo-900/40 active:scale-95 transition-transform">Simpan Wajah Permanen</button>
                        <p class="text-[9px] text-slate-500 text-center font-bold uppercase">Data wajah akan dienkripsi dan disimpan otomatis.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabel Log -->
        <div class="bg-white rounded-[3rem] shadow-xl border border-slate-100 overflow-hidden">
            <div class="p-8 border-b border-slate-50 flex flex-col md:flex-row justify-between items-center gap-6">
                <div>
                    <h2 class="text-xl font-[1000] text-slate-900 uppercase tracking-tighter italic">LOG PRESENSI DIGITAL</h2>
                    <p class="text-[10px] text-slate-400 font-bold uppercase mt-1">Status Database: <span id="syncStatus" class="text-indigo-600 italic">Menghubungkan...</span></p>
                </div>
                <div class="flex flex-wrap gap-3 items-center">
                    <div class="flex items-center bg-slate-50 px-4 py-2 rounded-2xl border border-slate-100">
                        <span class="text-[10px] font-black text-slate-400 uppercase mr-3">Filter:</span>
                        <input type="date" id="dateFilter" onchange="window.renderTable()" class="bg-transparent text-[11px] font-black uppercase outline-none text-slate-700">
                    </div>
                    <button id="btnPrint" class="bg-slate-900 text-white px-5 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-800 transition-colors">Cetak Laporan</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50">
                            <th class="p-6 text-[10px] font-black text-slate-400 uppercase tracking-widest border-b text-center">Waktu & Tanggal</th>
                            <th class="p-6 text-[10px] font-black text-slate-400 uppercase tracking-widest border-b">Pegawai</th>
                            <th class="p-6 text-[10px] font-black text-slate-400 uppercase tracking-widest border-b text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody"></tbody>
                </table>
                <div id="emptyState" class="hidden p-12 text-center text-[11px] font-black text-slate-300 uppercase tracking-[0.3em]">
                    Belum ada data tercatat
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SETTINGS -->
    <div id="settingsModal" class="fixed inset-0 bg-slate-900/80 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-[3rem] shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
            <div class="p-8 border-b flex justify-between items-center">
                <h2 class="text-xl font-[1000] italic uppercase">Konfigurasi Sistem</h2>
                <button onclick="window.toggleSettings()" class="text-slate-400 font-bold">X</button>
            </div>
            <div class="p-8 space-y-6 overflow-y-auto flex-1">
                <div>
                    <label class="block text-[10px] font-black uppercase mb-3 text-indigo-600">Manajemen Database</label>
                    <button onclick="window.clearFaceData()" class="text-[10px] bg-red-50 text-red-600 px-4 py-2 rounded-xl font-black uppercase">Hapus Semua Data Wajah</button>
                </div>
                <hr>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="kopOrg" class="w-full p-3 bg-slate-50 rounded-xl text-xs font-bold border" placeholder="Organisasi Atas">
                    <input type="text" id="kopSchool" class="w-full p-3 bg-slate-50 rounded-xl text-xs font-bold border" placeholder="Nama Sekolah">
                </div>
                <textarea id="kopAddress" class="w-full p-3 bg-slate-50 rounded-xl text-xs font-bold border h-20" placeholder="Alamat Lengkap"></textarea>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Firebase Config and Setup
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'smapanmu-face-system';

        let logs = JSON.parse(localStorage.getItem('smapanmu_logs')) || { harian: [], rapat: [], tamu: [] };
        let faceData = JSON.parse(localStorage.getItem('smapanmu_faces')) || [];
        
        let currentMode = 'harian';
        let faceMatcher = null;
        let isProcessing = false;
        let user = null;

        // --- AUTH INITIALIZATION (RULE 3) ---
        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        }

        // --- CORE LOGIC ---
        async function init() {
            const URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(URL)
            ]);
            document.getElementById('loader').classList.add('hidden');

            // Set connection status UI
            window.addEventListener('online', updateStatus);
            window.addEventListener('offline', updateStatus);
            updateStatus();

            // Run Authentication
            await initAuth();

            onAuthStateChanged(auth, (u) => {
                user = u;
                if (user) {
                    console.log("Authenticated as:", user.uid);
                    // Only start syncing AFTER auth is confirmed (RULE 3)
                    syncFacesFromCloud();
                    syncLogsFromCloud();
                }
            });

            rebuildMatcher();
            startCamera();
            renderTable();
        }

        function updateStatus() {
            const status = document.getElementById('syncStatus');
            if (navigator.onLine) {
                document.body.classList.remove('is-offline');
                status.textContent = "Online - Cloud Sync Aktif";
                status.className = "text-indigo-600 italic";
            } else {
                document.body.classList.add('is-offline');
                status.textContent = "Offline - Local Storage Aktif";
                status.className = "text-amber-600 italic";
            }
        }

        // --- FACE DATA MANAGEMENT (RULE 1: Correct Paths) ---
        function rebuildMatcher() {
            if (faceData.length === 0) {
                faceMatcher = null;
                return;
            }
            try {
                const labeledDescriptors = faceData.map(fd => {
                    const descriptors = fd.descriptors.map(d => new Float32Array(Object.values(d)));
                    return new faceapi.LabeledFaceDescriptors(fd.label, descriptors);
                });
                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
            } catch (e) {
                console.error("Failed to rebuild matcher:", e);
            }
        }

        async function saveFaceToStorage(label, descriptors) {
            const newEntry = { label, descriptors: descriptors.map(d => Array.from(d)) };
            
            // 1. Save Locally
            faceData.push(newEntry);
            localStorage.setItem('smapanmu_faces', JSON.stringify(faceData));
            rebuildMatcher();

            // 2. Save to Cloud (RULE 1 & 3)
            if (navigator.onLine && user) {
                try {
                    // Path: /artifacts/{appId}/public/data/{collection}/{docId}
                    const cleanLabel = label.replace(/[^a-zA-Z0-9]/g, '_');
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'face_registry', cleanLabel);
                    await setDoc(docRef, newEntry);
                } catch (e) { 
                    console.error("Cloud face save failed:", e); 
                }
            }
        }

        function syncFacesFromCloud() {
            if (!user) return;
            // RULE 1: Correct collection path
            const cloudPath = collection(db, 'artifacts', appId, 'public', 'data', 'face_registry');
            onSnapshot(cloudPath, (snap) => {
                const cloudFaces = snap.docs.map(d => d.data());
                if (cloudFaces.length > 0) {
                    let updated = false;
                    cloudFaces.forEach(cf => {
                        if (!faceData.find(lf => lf.label === cf.label)) {
                            faceData.push(cf);
                            updated = true;
                        }
                    });
                    if (updated) {
                        localStorage.setItem('smapanmu_faces', JSON.stringify(faceData));
                        rebuildMatcher();
                    }
                }
            }, (error) => {
                console.error("Face sync error:", error);
            });
        }

        // --- LOG MANAGEMENT (RULE 1: Correct Paths) ---
        async function saveLog(entry) {
            logs[currentMode].unshift(entry);
            localStorage.setItem('smapanmu_logs', JSON.stringify(logs));
            window.renderTable();

            if (navigator.onLine && user) {
                try {
                    // Path: /artifacts/{appId}/public/data/{collection}
                    const cloudPath = collection(db, 'artifacts', appId, 'public', 'data', `logs_${currentMode}`);
                    await addDoc(cloudPath, { 
                        ...entry, 
                        uid: user.uid,
                        serverTime: serverTimestamp() 
                    });
                } catch (e) {
                    console.error("Log upload failed:", e);
                }
            }
        }

        function syncLogsFromCloud() {
            if (!user) return;
            const cloudPath = collection(db, 'artifacts', appId, 'public', 'data', `logs_${currentMode}`);
            onSnapshot(cloudPath, (snap) => {
                // Background sync logic can go here
                // Note: RULE 2 - we avoid complex queries and filters here
            }, (error) => {
                console.error("Log sync error:", error);
            });
        }

        // --- CAMERA & DETECTION ---
        function startCamera() {
            const video = document.getElementById('video');
            navigator.mediaDevices.getUserMedia({ video: true }).then(s => video.srcObject = s).catch(e => console.error(e));
            
            video.addEventListener('play', () => {
                const canvas = faceapi.createCanvasFromMedia(video);
                document.querySelector('.video-wrapper').append(canvas);
                const size = { width: video.offsetWidth, height: video.offsetHeight };
                faceapi.matchDimensions(canvas, size);

                setInterval(async () => {
                    if (isProcessing) return;
                    const detect = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                    if (detect) {
                        const l = detect.landmarks.getLeftEye();
                        const r = detect.landmarks.getRightEye();
                        const ear = (getEAR(l) + getEAR(r)) / 2;
                        if (ear < 0.28) { 
                            isProcessing = true;
                            handleMatch(detect.descriptor);
                        }
                    }
                }, 200);
            });
        }

        function getEAR(e) {
            const v = Math.hypot(e[1].x-e[5].x, e[1].y-e[5].y) + Math.hypot(e[2].x-e[4].x, e[2].y-e[4].y);
            const h = Math.hypot(e[0].x-e[3].x, e[0].y-e[3].y);
            return v/(2*h);
        }

        async function handleMatch(desc) {
            let identity = { name: "ASING", job: "Tak Terdaftar" };
            let identified = false;

            if (faceMatcher) {
                const match = faceMatcher.findBestMatch(desc);
                if (match.label !== 'unknown') {
                    const [n, j] = match.label.split('|');
                    identity = { name: n, job: j }; identified = true;
                }
            }

            if (identified) {
                const now = new Date();
                const dateISO = now.toISOString().split('T')[0];
                const exists = logs[currentMode].find(l => l.name === identity.name && l.fullDate === dateISO);
                
                if (exists) {
                    notify(identity.name, "SUDAH ABSEN HARI INI", "bg-amber-500");
                } else {
                    const entry = {
                        ...identity,
                        time: now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}),
                        dateDisplay: now.toLocaleDateString('id-ID', {day:'numeric', month:'short'}),
                        fullDate: dateISO,
                        status: "TEPAT WAKTU"
                    };
                    await saveLog(entry);
                    notify(identity.name, "VERIFIKASI BERHASIL", "bg-emerald-500");
                }
            }
            setTimeout(() => isProcessing = false, 3000);
        }

        function notify(title, desc, color) {
            const card = document.getElementById('statusCard');
            card.className = `${color} p-8 rounded-[3rem] shadow-2xl transition-all text-white`;
            document.getElementById('statusTitle').textContent = title;
            document.getElementById('statusDesc').textContent = desc;
            setTimeout(() => {
                card.className = `bg-white p-8 rounded-[3rem] shadow-2xl border border-slate-100 transition-all text-slate-900`;
                document.getElementById('statusTitle').textContent = "SIAP VERIFIKASI";
                document.getElementById('statusDesc').textContent = "Arahkan Wajah & Kedipkan Mata";
                document.getElementById('statusDesc').className = "text-[11px] text-slate-400 font-bold uppercase tracking-wider";
            }, 3000);
        }

        // --- WINDOW ACTIONS ---
        window.renderTable = () => {
            const filter = document.getElementById('dateFilter').value;
            let data = logs[currentMode];
            if (filter) data = data.filter(l => l.fullDate === filter);

            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = data.map(l => `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="p-6 text-center font-bold italic">${l.dateDisplay} <br> <span class="text-indigo-600">${l.time}</span></td>
                    <td class="p-6"><b>${l.name}</b><br><small class="uppercase text-slate-400 font-bold">${l.job}</small></td>
                    <td class="p-6 text-center"><span class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-[9px] font-black">${l.status}</span></td>
                </tr>
            `).join('');
            document.getElementById('emptyState').classList.toggle('hidden', data.length > 0);
        };

        window.changeMode = (m) => {
            currentMode = m;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.id === `btn-${m}`));
            window.renderTable();
        };

        window.toggleSettings = () => document.getElementById('settingsModal').classList.toggle('hidden');
        
        window.clearFaceData = () => {
            if (confirm("Hapus semua database wajah? Tindakan ini tidak bisa dibatalkan.")) {
                localStorage.removeItem('smapanmu_faces');
                faceData = [];
                rebuildMatcher();
                alert("Database lokal dibersihkan.");
            }
        };

        document.getElementById('startRegBtn').onclick = async () => {
            const name = document.getElementById('nameInput').value.trim();
            const job = document.getElementById('jobInput').value.trim();
            if (!name || !job) return alert("Lengkapi Nama dan Jabatan!");
            
            document.getElementById('statusTitle').textContent = "MEREKAM...";
            let samples = [];
            const video = document.getElementById('video');
            
            for(let i=0; i<3; i++) {
                const d = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                if (d) samples.push(d.descriptor);
                await new Promise(r => setTimeout(r, 600));
            }

            if (samples.length >= 2) {
                await saveFaceToStorage(`${name}|${job}`, samples);
                alert(`Wajah ${name} Berhasil Disimpan Secara Permanen!`);
                document.getElementById('nameInput').value = "";
                document.getElementById('jobInput').value = "";
            } else {
                alert("Gagal merekam. Pastikan pencahayaan cukup dan wajah terlihat jelas.");
            }
            document.getElementById('statusTitle').textContent = "SIAP VERIFIKASI";
        };

        document.getElementById('btnPrint').onclick = () => window.print();

        // Start initialization
        init();
    </script>
</body>
</html>
