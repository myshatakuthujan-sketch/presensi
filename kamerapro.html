<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ProCam Ultra - Cinema Suite v17</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
            margin: 0;
            padding: 0;
            user-select: none;
        }

        .camera-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #000;
        }

        .camera-preview {
            flex: 1;
            position: relative;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #111;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease-out;
            transform-origin: center center;
        }

        /* Logic for Mirror Effect */
        .mirror-active {
            transform: scaleX(-1) !important;
        }

        .ui-tray {
            position: absolute; left: 0; width: 100%; z-index: 50;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .filter-tray { 
            top: 90px; 
            display: flex; 
            gap: 12px; 
            overflow-x: auto; 
            padding: 15px 20px; 
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(15px);
            scrollbar-width: none;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .filter-tray::-webkit-scrollbar { display: none; }

        .zoom-overlay, .speed-overlay { 
            bottom: 160px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding-bottom: 15px;
        }

        .speed-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 12px;
            background: rgba(0,0,0,0.85);
            border-radius: 24px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.15);
        }

        /* --- FILTER LIBRARY --- */
        .filter-none { filter: none; }
        .filter-bw { filter: grayscale(1) contrast(1.2); }
        .filter-noir { filter: grayscale(1) contrast(1.8) brightness(0.7); }
        .filter-m5 { filter: sepia(0.3) contrast(1.1) brightness(0.9) saturate(0.8); }
        .filter-c1 { filter: saturate(1.6) contrast(1.1) brightness(1.1); }
        .filter-f2 { filter: sepia(0.2) contrast(0.9) brightness(1.1) saturate(0.7) blur(0.2px); }
        .filter-g3 { filter: contrast(1.05) saturate(1.2) brightness(1.05) hue-rotate(-5deg); }
        .filter-teal-orange { filter: contrast(1.25) saturate(1.4) hue-rotate(-15deg) brightness(0.95); }
        .filter-warm-nostalgia { filter: sepia(0.5) saturate(1.4) brightness(1.05) contrast(1.1); }
        .filter-cool-desat { filter: hue-rotate(190deg) saturate(0.5) contrast(1.1) brightness(1.1); }
        .filter-dark-moody { filter: brightness(0.6) contrast(1.6) saturate(0.8) sepia(0.1); }
        .filter-diffusion { filter: blur(0.8px) brightness(1.1) contrast(0.9) saturate(1.1); }
        .filter-grainy { filter: contrast(1.2) brightness(1.1) grayscale(0.2) url(#noise); }
        .filter-dreamy { filter: opacity(0.9) contrast(0.8) brightness(1.2) blur(1.5px) saturate(1.3); }
        .filter-vhs { filter: contrast(0.9) saturate(1.3) hue-rotate(10deg) sepia(0.2); }
        .filter-cpm35 { filter: sepia(0.4) saturate(1.5) contrast(1.1) brightness(0.9); }
        .filter-pastel { filter: brightness(1.2) saturate(0.8) contrast(0.8) sepia(0.1); }
        .filter-brown { filter: sepia(0.6) contrast(1.1) brightness(0.95) saturate(0.9); }
        .filter-minimalist { filter: contrast(1.1) brightness(1.05) saturate(0.85); }
        .filter-blue-hiphop { filter: hue-rotate(180deg) saturate(1.5) contrast(1.2) brightness(0.9); }
        .magic-auto-active { filter: brightness(1.15) contrast(1.1) saturate(1.2) !important; }

        .active-btn { background-color: #ffcc00 !important; color: black !important; border-color: #ffcc00 !important; }
        
        .filter-card { flex: 0 0 auto; width: 75px; display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; }
        .filter-thumb { width: 55px; height: 55px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.25); background: #222; transition: all 0.2s; }
        .active .filter-thumb { border-color: #ffcc00; transform: scale(1.1); }
        .filter-name { font-size: 8px; font-weight: 700; text-transform: uppercase; color: rgba(255,255,255,0.6); text-align: center; }
        .active .filter-name { color: #ffcc00; }

        .hidden-tray { transform: translateY(-20px); opacity: 0; pointer-events: none; }
        .speed-overlay.hidden-tray, .zoom-overlay.hidden-tray { transform: translateY(20px); }

        .shutter-photo { width: 72px; height: 72px; background: #fff; border-radius: 50%; border: 5px solid rgba(255, 255, 255, 0.3); transition: transform 0.1s; }
        .shutter-photo:active { transform: scale(0.9); }
        #recording-dot { width: 18px; height: 18px; background: #ff0000; border-radius: 50%; transition: all 0.3s; }
        .recording-active #recording-dot { border-radius: 4px; transform: scale(0.8); }

        #save-toast {
            position: fixed; top: 12%; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: #fff; color: #000; padding: 10px 25px; border-radius: 50px;
            font-size: 12px; font-weight: bold; z-index: 1000; transition: transform 0.5s;
        }
        #save-toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <svg style="display:none;"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch" /><feComponentTransfer><feFuncR type="linear" slope="0.1" /><feFuncG type="linear" slope="0.1" /><feFuncB type="linear" slope="0.1" /></feComponentTransfer><feComposite operator="in" in2="SourceGraphic" /><feBlend mode="overlay" in2="SourceGraphic" /></filter></svg>

    <div id="save-toast">Pesan Disimpan</div>
    <div id="flash-overlay" class="fixed inset-0 bg-white opacity-0 pointer-events-none z-[100] transition-opacity duration-100"></div>

    <div class="camera-container">
        <!-- Kontrol Header -->
        <div class="absolute top-0 left-0 w-full pt-12 pb-4 px-4 flex justify-between items-center z-[60] bg-gradient-to-b from-black/90 to-transparent">
            <div class="flex items-center gap-2">
                <div id="recording-indicator" class="hidden flex items-center bg-red-600/90 px-3 py-1 rounded-full text-[10px] font-bold">
                    <span class="w-2 h-2 rounded-full bg-white animate-ping mr-2"></span>
                    <span id="timer">00:00</span>
                </div>
                <button onclick="toggleMagicAuto()" id="btn-magic" class="bg-black/50 px-3 py-2 rounded-full border border-white/20 text-[9px] font-bold uppercase">Magic</button>
                <button onclick="toggleMirror()" id="btn-mirror" class="bg-black/50 px-3 py-2 rounded-full border border-white/20 text-[9px] font-bold uppercase">Mirror</button>
            </div>
            
            <div class="flex gap-2">
                <button onclick="cycleFlash()" id="btn-flash" class="bg-black/50 p-2.5 rounded-full border border-white/20 text-[9px] font-bold uppercase">⚡ Off</button>
                <button onclick="toggleGrid()" id="btn-grid-top" class="bg-black/50 p-2.5 rounded-full border border-white/20"><svg width="18" height="18" fill="white" viewBox="0 0 24 24"><path d="M4 8h4V4H4v4zm6 0h4V4h-4v4zm6-4v4h4V4h-4zM4 14h4v-4H4v4zm6 0h4v-4h-4v4zm6 0h4v-4h-4v4zM4 20h4v-4H4v4zm6 0h4v-4h-4v4zm6 0h4v-4h-4v4z"/></svg></button>
                <button onclick="toggleTray('filter')" id="btn-filter-toggle" class="bg-black/50 p-2.5 rounded-full border border-white/20"><svg width="18" height="18" fill="white" viewBox="0 0 24 24"><path d="M14.73 20.83L17.58 18L14.73 15.17L15.85 14.03L20 18.17L15.85 22.31L14.73 20.83M10.5 12.78L12.75 15L8.5 19.25L4.25 15L6.5 12.78L10.5 12.78M10.5 3L15 7.5L10.5 12L6 7.5L10.5 3Z"/></svg></button>
                <button onclick="toggleTray('speed')" id="btn-speed-toggle" class="bg-black/50 p-2.5 rounded-full border border-white/20 text-[10px] font-bold min-w-[42px]">1x</button>
                <button onclick="toggleTray('zoom')" id="btn-zoom-toggle" class="bg-black/50 p-2.5 rounded-full border border-white/20 text-[10px] font-bold min-w-[42px]">1.0x</button>
                <button onclick="switchCamera()" class="bg-black/50 p-2.5 rounded-full border border-white/20"><svg width="18" height="18" fill="white" viewBox="0 0 24 24"><path d="M19 8l-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3l-4-4zM6 12c0-3.31 2.69-6 6-6 1.01 0-1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4H6z"/></svg></button>
            </div>
        </div>

        <div class="camera-preview">
            <div id="camera-error-msg" class="absolute inset-0 z-10 flex flex-col items-center justify-center p-6 text-center hidden">
                <svg class="w-12 h-12 text-gray-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <p id="error-text" class="text-sm text-gray-400 font-medium">Meminta akses kamera...</p>
                <button onclick="initCamera()" class="mt-4 px-6 py-2 bg-white text-black text-xs font-bold rounded-full uppercase tracking-widest">Coba Lagi</button>
            </div>
            <canvas id="brightness-canvas" style="display:none;"></canvas>
            <video id="video" autoplay playsinline muted></video>
            <div id="grid-lines" class="absolute inset-0 pointer-events-none hidden">
                <div class="absolute w-full h-[0.5px] bg-white/40 top-1/3"></div>
                <div class="absolute w-full h-[0.5px] bg-white/40 top-2/3"></div>
                <div class="absolute h-full w-[0.5px] bg-white/40 left-1/3"></div>
                <div class="absolute h-full w-[0.5px] bg-white/40 left-2/3"></div>
            </div>
        </div>

        <!-- Trays -->
        <div id="filter-tray" class="ui-tray filter-tray hidden-tray"></div>
        
        <div id="zoom-tray" class="ui-tray zoom-overlay hidden-tray">
            <input type="range" id="zoom-slider" min="0.5" max="16" step="0.1" value="1" class="w-2/3 accent-yellow-400" oninput="updateZoom(this.value)">
            <span class="text-[11px] font-extrabold text-yellow-400 mt-2 bg-black/60 px-3 py-1 rounded-full" id="zoom-text">1.0x</span>
        </div>

        <div id="speed-tray" class="ui-tray speed-overlay hidden-tray">
            <div class="speed-grid">
                <button onclick="setVideoSpeed(0.5)" id="speed-0.5" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-[9px] font-bold">0.5x</button>
                <button onclick="setVideoSpeed(1)" id="speed-1" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-[9px] font-bold active-btn">1x</button>
                <button onclick="setVideoSpeed(2)" id="speed-2" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-[9px] font-bold">2x</button>
                <button onclick="setVideoSpeed(4)" id="speed-4" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-[9px] font-bold">4x</button>
                <button onclick="setVideoSpeed(8)" id="speed-8" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-[9px] font-bold">8x</button>
                <button onclick="setVideoSpeed(16)" id="speed-16" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-[9px] font-bold">16x</button>
            </div>
        </div>

        <!-- Bottom Controls -->
        <div class="w-full px-10 pt-4 pb-16 flex justify-between items-center bg-black">
            <div id="gallery-preview" class="w-12 h-12 rounded-lg border-2 border-white/30 bg-cover bg-center overflow-hidden" onclick="openEditor()">
                <div class="w-full h-full bg-white/5 flex items-center justify-center opacity-40 text-[9px] font-bold">GALLERY</div>
            </div>
            
            <button onclick="handleCapture()" class="shutter-photo active:scale-95 transition-transform"></button>
            
            <button onclick="toggleRecording()" id="video-trigger" class="w-14 h-14 rounded-full border-2 border-white/40 flex items-center justify-center">
                <div id="recording-dot"></div>
            </button>
        </div>
    </div>

    <!-- Editor Overlay -->
    <div id="editor-overlay" class="fixed inset-0 bg-black z-[200] hidden flex flex-col">
        <div class="p-4 flex justify-between border-b border-white/10">
            <button onclick="closeEditor()" class="text-[11px] font-bold opacity-60 tracking-widest">TUTUP</button>
            <button id="save-btn" onclick="saveEditedPhoto()" class="text-[11px] font-bold text-yellow-400 tracking-widest">SIMPAN</button>
        </div>
        <div class="flex-1 flex items-center justify-center p-4 bg-zinc-900 overflow-hidden relative">
            <canvas id="editor-canvas" class="max-w-full max-h-full shadow-2xl"></canvas>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const gridLines = document.getElementById('grid-lines');
        const galleryPreview = document.getElementById('gallery-preview');
        const editorCanvas = document.getElementById('editor-canvas');
        const ctx = editorCanvas.getContext('2d');
        const brightnessCanvas = document.getElementById('brightness-canvas');
        const bCtx = brightnessCanvas.getContext('2d');
        const errorMsg = document.getElementById('camera-error-msg');
        const errorText = document.getElementById('error-text');
        
        let isFrontCamera = false;
        let activeFilter = 'none';
        let currentZoom = 1;
        let isMagicAuto = false;
        let isMirror = false; // New state for mirror mode
        let lastCapturedImage = null;
        let isRecording = false;
        let currentSpeed = 1;
        let recordStartTime = 0;
        let timerInterval = null;
        let mediaRecorder;
        let recordedChunks = [];
        let flashMode = 'off';
        let currentStream = null;

        const FILTERS = [
            { id: 'none', name: 'Asli' }, { id: 'teal-orange', name: 'Teal' }, { id: 'warm-nostalgia', name: 'Warm' },
            { id: 'dark-moody', name: 'Moody' }, { id: 'cool-desat', name: 'Cool' }, { id: 'diffusion', name: 'Mist' },
            { id: 'dreamy', name: 'Dreamy' }, { id: 'grainy', name: 'Film' }, { id: 'bw', name: 'Drama' },
            { id: 'vhs', name: 'VHS' }, { id: 'cpm35', name: 'Dazz' }, { id: 'pastel', name: 'Pastel' },
            { id: 'm5', name: 'M5' }, { id: 'c1', name: 'C1' }, { id: 'f2', name: 'F2' }, { id: 'g3', name: 'G3' }
        ];

        async function initCamera() {
            errorMsg.classList.add('hidden');
            if (currentStream) {
                currentStream.getTracks().forEach(t => t.stop());
            }
            
            const configs = [
                {
                    video: { 
                        facingMode: isFrontCamera ? 'user' : 'environment', 
                        width: { ideal: 3840 },
                        height: { ideal: 2160 }
                    },
                    audio: true
                },
                {
                    video: { 
                        facingMode: isFrontCamera ? 'user' : 'environment', 
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: true
                },
                {
                    video: { facingMode: isFrontCamera ? 'user' : 'environment' },
                    audio: true
                }
            ];

            let success = false;
            for (let config of configs) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia(config);
                    currentStream = stream;
                    video.srcObject = stream;
                    
                    updateFilters(); // Refresh transform classes
                    
                    video.onloadedmetadata = () => {
                        video.play().catch(e => console.error("Video play failed:", e));
                    };
                    success = true;
                    break;
                } catch (e) {
                    console.warn(`Gagal dengan config:`, config, e);
                }
            }

            if (!success) {
                errorMsg.classList.remove('hidden');
                errorText.innerText = "Kamera tidak dapat dimulai. Pastikan izin kamera diaktifkan.";
            }
        }

        function cycleFlash() {
            const btn = document.getElementById('btn-flash');
            if(flashMode === 'off') {
                flashMode = 'on'; btn.innerText = '⚡ On'; btn.classList.add('active-btn');
            } else if(flashMode === 'on') {
                flashMode = 'auto'; btn.innerText = '⚡ Auto'; btn.classList.add('active-btn');
            } else {
                flashMode = 'off'; btn.innerText = '⚡ Off'; btn.classList.remove('active-btn');
            }
        }

        function getBrightness() {
            try {
                brightnessCanvas.width = 50; brightnessCanvas.height = 50;
                bCtx.drawImage(video, 0, 0, 50, 50);
                const data = bCtx.getImageData(0, 0, 50, 50).data;
                let total = 0;
                for(let i=0; i<data.length; i+=4) total += (data[i] + data[i+1] + data[i+2]) / 3;
                return total / (data.length / 4);
            } catch(e) { return 100; }
        }

        function toggleMagicAuto() {
            isMagicAuto = !isMagicAuto;
            document.getElementById('btn-magic').classList.toggle('active-btn', isMagicAuto);
            updateFilters();
        }

        function toggleMirror() {
            isMirror = !isMirror;
            document.getElementById('btn-mirror').classList.toggle('active-btn', isMirror);
            updateFilters();
        }

        function toggleGrid() {
            gridLines.classList.toggle('hidden');
            document.getElementById('btn-grid-top').classList.toggle('active-btn', !gridLines.classList.contains('hidden'));
        }

        function setVideoSpeed(speed) {
            currentSpeed = speed;
            document.getElementById('btn-speed-toggle').innerText = speed + 'x';
            document.querySelectorAll('.speed-grid button').forEach(b => b.classList.remove('active-btn'));
            const target = document.getElementById('speed-' + speed);
            if(target) target.classList.add('active-btn');
            showToast(`Kecepatan: ${speed}x`);
        }

        function updateZoom(val) {
            currentZoom = val;
            applyTransform();
            document.getElementById('zoom-text').innerText = parseFloat(val).toFixed(1) + 'x';
            document.getElementById('btn-zoom-toggle').innerText = parseFloat(val).toFixed(1) + 'x';
        }

        function setFilter(id) {
            activeFilter = id;
            updateFilters();
            renderFilters();
        }

        function updateFilters() {
            video.className = `filter-${activeFilter} ${isMagicAuto ? 'magic-auto-active' : ''}`;
            applyTransform();
        }

        function applyTransform() {
            // Combine zoom and mirror/facing flips
            // Default: scale(zoom)
            // If Front Cam: scale(zoom) scaleX(-1)
            // If Mirror Toggle Active: Flip the current horizontal scale
            let scaleX = (isFrontCamera) ? -1 : 1;
            if (isMirror) scaleX *= -1;
            
            video.style.transform = `scale(${currentZoom}) scaleX(${scaleX})`;
        }

        function toggleTray(type) {
            const trays = ['filter', 'zoom', 'speed'];
            trays.forEach(t => {
                const el = document.getElementById(`${t}-tray`);
                if(t === type) el.classList.toggle('hidden-tray');
                else el.classList.add('hidden-tray');
            });
        }

        function renderFilters() {
            const tray = document.getElementById('filter-tray');
            tray.innerHTML = '';
            FILTERS.forEach(f => {
                const card = document.createElement('div');
                card.className = `filter-card ${f.id === activeFilter ? 'active' : ''}`;
                card.onclick = () => setFilter(f.id);
                card.innerHTML = `<div class="filter-thumb filter-${f.id}"></div><span class="filter-name">${f.name}</span>`;
                tray.appendChild(card);
            });
        }

        function handleCapture() {
            if(!video.videoWidth) {
                showToast("Kamera belum siap");
                return;
            }
            let needsFlash = (flashMode === 'on' || (flashMode === 'auto' && getBrightness() < 70));
            if(needsFlash) {
                document.getElementById('flash-overlay').style.opacity = '1';
                setTimeout(() => { capturePhoto(); document.getElementById('flash-overlay').style.opacity = '0'; }, 50);
            } else {
                capturePhoto();
                document.getElementById('flash-overlay').style.opacity = '0.3';
                setTimeout(() => document.getElementById('flash-overlay').style.opacity = '0', 50);
            }
        }

        function capturePhoto() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; 
            canvas.height = video.videoHeight;
            const c = canvas.getContext('2d');
            
            c.imageSmoothingEnabled = true;
            c.imageSmoothingQuality = 'high';

            // Apply Mirror/Flip to Canvas to match Preview
            let scaleX = (isFrontCamera) ? -1 : 1;
            if (isMirror) scaleX *= -1;

            if(scaleX === -1) { 
                c.translate(canvas.width, 0); 
                c.scale(-1, 1); 
            }
            
            c.filter = getComputedStyle(video).filter;
            
            const sw = video.videoWidth / currentZoom;
            const sh = video.videoHeight / currentZoom;
            c.drawImage(video, (video.videoWidth-sw)/2, (video.videoHeight-sh)/2, sw, sh, 0, 0, canvas.width, canvas.height);
            
            lastCapturedImage = canvas.toDataURL('image/jpeg', 1.0);
            galleryPreview.style.backgroundImage = `url(${lastCapturedImage})`;
            showToast("Foto Disimpan");
        }

        function toggleRecording() {
            if (!isRecording) startRecording();
            else stopRecording();
        }

        function startRecording() {
            const stream = video.srcObject;
            if (!stream || stream.getTracks().length === 0) {
                showToast("Kamera belum siap");
                return;
            }

            recordedChunks = [];
            
            const mimeTypes = [
                'video/mp4;codecs=h264',
                'video/webm;codecs=h264',
                'video/webm;codecs=vp9',
                'video/webm'
            ];
            
            let selectedMimeType = '';
            for (let type of mimeTypes) {
                if (MediaRecorder.isTypeSupported(type)) {
                    selectedMimeType = type;
                    break;
                }
            }
            
            try {
                const options = { 
                    mimeType: selectedMimeType,
                    videoBitsPerSecond: 8000000 
                };
                mediaRecorder = new MediaRecorder(stream, options);
                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = saveVideo;
                mediaRecorder.start(1000); 
                
                isRecording = true;
                document.getElementById('video-trigger').classList.add('recording-active');
                document.getElementById('recording-indicator').classList.remove('hidden');
                recordStartTime = Date.now();
                timerInterval = setInterval(updateTimer, 1000);
            } catch (e) { 
                console.error("Recording Error:", e);
                showToast("Gagal merekam"); 
            }
        }

        function stopRecording() {
            if(mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('video-trigger').classList.remove('recording-active');
                document.getElementById('recording-indicator').classList.add('hidden');
                clearInterval(timerInterval);
            }
        }

        function saveVideo() {
            if (recordedChunks.length === 0) return;
            
            let extension = 'webm';
            if (mediaRecorder.mimeType.includes('mp4')) extension = 'mp4';
            
            const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `VIDEO_PRO_${Date.now()}.${extension}`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 500);
            showToast(`Video Tersimpan`);
        }

        function updateTimer() {
            const diff = Math.floor((Date.now() - recordStartTime) / 1000);
            const m = String(Math.floor(diff / 60)).padStart(2, '0');
            const s = String(diff % 60).padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }

        function openEditor() {
            if(!lastCapturedImage) {
                showToast("Ambil foto dulu");
                return;
            }
            document.getElementById('editor-overlay').classList.remove('hidden');
            const img = new Image();
            img.onload = () => { 
                editorCanvas.width = img.width; 
                editorCanvas.height = img.height; 
                ctx.drawImage(img, 0, 0); 
            };
            img.src = lastCapturedImage;
        }

        function closeEditor() { document.getElementById('editor-overlay').classList.add('hidden'); }
        
        function saveEditedPhoto() {
            const a = document.createElement('a');
            a.href = editorCanvas.toDataURL('image/jpeg', 1.0);
            a.download = `EDIT_PRO_${Date.now()}.jpg`;
            a.click();
            showToast("Edit Tersimpan");
            closeEditor();
        }
        
        function showToast(msg) {
            const toast = document.getElementById('save-toast');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
        
        function switchCamera() { 
            isFrontCamera = !isFrontCamera; 
            initCamera(); 
        }

        window.onload = () => { 
            initCamera(); 
            renderFilters(); 
        };
    </script>
</body>
</html>
