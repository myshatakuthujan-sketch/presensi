<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Portal Guru SMAPANMU</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="data:application/json;base64,ewogICJnameiOiAiUG9ydGFsIEd1cnUgU01BUEFOTVUiLAogICJzaG9ydF9uYW1lIjogIlNNQVBBTk1VIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmOGZhZmMiLAogICJ0aGVtZV9jb3xvciI6ICIjMWU0MGFmIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9ibG9nZ2VyLmdvb2dsZXVzZXJjb250ZW50LmNvbS9pbmcvYi9SMjl2WlhFaTJpV2lWOGREOTF0V0Q4djI0c2ZZR05MOWpYeGhScDJlcENoU2FhdjFRUTNDWldoUmI3NTNYRkdRT3NUOXU4MmtFRVFBVmtkWlZLYmJRMkk0VGtoa3I5aDAwS0prYVluWkt6STktSFB1VXFjTzZBM1VYRlo5bDQzcUYwc2FqTXFzNWFzbTJ0dGR2allVeHN4c3dJTkNCZjdiTjdnY05vb3EtUjBLVlNGd2lya1RlVElDZTZjVG5HbHlQbVEvczE2MDAvbG9nbyUyMG1hcGFuLnBuZyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfQogIF0KfQ==">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root { --primary: #1e40af; --accent: #3b82f6; }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            padding-top: env(safe-area-inset-top);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .table-container {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }

        .sticky-col { 
            position: sticky; 
            left: 0; 
            background: #ffffff; 
            z-index: 10; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.05); 
        }

        .header-sticky { 
            position: sticky; 
            top: 0; 
            z-index: 20; 
            background: #0f172a;
        }

        .tab-active { 
            background: white; 
            color: #1e40af; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            font-weight: 800; 
        }

        .my-schedule-cell { 
            background: linear-gradient(135deg, #2563eb, #1e40af);
            color: white !important; 
            font-weight: 800; 
            border-radius: 12px; 
            padding: 8px 4px; 
            min-width: 80px; 
            font-size: 11px;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }

        .btn-admin-float {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 50;
        }
    </style>
</head>
<body class="min-h-screen text-slate-900 pb-20">

    <!-- Login Overlay -->
    <div id="loginOverlay" class="fixed inset-0 z-[1000] bg-slate-900/80 backdrop-blur-xl flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300">
            <div class="p-8 text-center bg-gradient-to-br from-blue-700 to-blue-900 text-white">
                <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi2iWi5Y8Dt91tWD8v24sfYGNL9jWxhRp2epChSaav1QQ3CZWhRb753XFGQOsT9u82kEEQAVkdZVKbbQ2I4Tkhkr9h00KJkaYnZK3jI-HPuUqcO6A3UXFZ9l43qF0sajMqs5asm2ttdvjYUxsxswINcBf7bN7gcNooq-R0KVSFwirkTeTICe6cTnGlyPmQ/s1600/logo%20mapan.png" class="h-16 mx-auto mb-4 drop-shadow-lg" alt="Logo SMAPANMU">
                <h2 class="text-xl font-extrabold uppercase tracking-tight">PORTAL GURU</h2>
                <p class="text-blue-200 text-[10px] uppercase font-bold tracking-widest opacity-80">SMAPANMU System v2.3</p>
            </div>
            <div class="p-8 space-y-5">
                <div class="space-y-1">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase ml-2">Pilih Akses</label>
                    <select id="loginRole" onchange="toggleLoginInput()" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl font-bold focus:ring-2 focus:ring-blue-500 outline-none appearance-none">
                        <option value="guru">üë§ GURU (DATA PRIBADI)</option>
                        <option value="admin">üîë ADMIN (AKSES SEMUA)</option>
                    </select>
                </div>
                <div id="guruInputGroup" class="space-y-1">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase ml-2">Nama Lengkap</label>
                    <input type="text" id="loginUsername" placeholder="Contoh: Dani, S.Pd" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="adminInputGroup" class="hidden space-y-1">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase ml-2">Password</label>
                    <input type="password" id="adminPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="btnEnter" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-bold shadow-xl active:scale-95 transition-all uppercase tracking-wider text-sm">Masuk Portal</button>
            </div>
        </div>
    </div>

    <!-- Admin Floating Button -->
    <div id="adminControls" class="hidden btn-admin-float">
        <button onclick="openMasterDatabase()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-4 rounded-2xl shadow-2xl font-black text-xs uppercase tracking-widest flex items-center gap-3 active:scale-90 transition-all">
            <span>‚öôÔ∏è</span> KELOLA DATABASE
        </button>
    </div>

    <div id="mainApp" class="hidden max-w-4xl mx-auto px-4 pt-4">
        <!-- Profile Header -->
        <div class="mb-4 glass-card p-5 rounded-[2rem] shadow-sm border border-white">
            <div class="flex items-center gap-4 mb-5">
                <div class="bg-blue-600 p-2 rounded-2xl shadow-inner">
                    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi2iWi5Y8Dt91tWD8v24sfYGNL9jWxhRp2epChSaav1QQ3CZWhRb753XFGQOsT9u82kEEQAVkdZVKbbQ2I4Tkhkr9h00KJkaYnZK3jI-HPuUqcO6A3UXFZ9l43qF0sajMqs5asm2ttdvjYUxsxswINcBf7bN7gcNooq-R0KVSFwirkTeTICe6cTnGlyPmQ/s1600/logo%20mapan.png" class="h-10 w-auto" alt="Logo">
                </div>
                <div class="flex-1 overflow-hidden">
                    <h1 id="appTitle" class="text-lg font-extrabold text-slate-900 leading-tight truncate">Portal Guru</h1>
                    <div class="flex items-center gap-2 mt-0.5">
                        <span id="userCodes" class="text-[9px] bg-blue-600 text-white px-2 py-0.5 rounded-lg font-black tracking-widest shadow-sm">...</span>
                        <p id="userStatus" class="text-[9px] text-slate-400 font-bold uppercase truncate">GURU SMAPANMU</p>
                    </div>
                </div>
                <button id="logoutBtn" class="bg-slate-100 p-3 rounded-2xl text-slate-400 active:bg-red-50 active:text-red-500 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                </button>
            </div>

            <div class="flex items-center justify-between pt-4 border-t border-slate-100">
                <div class="flex flex-col">
                    <span id="displayDate" class="text-[9px] font-black text-slate-300 uppercase tracking-widest">MEMUAT...</span>
                    <span id="displayTime" class="text-2xl font-black text-slate-900 tabular-nums">00:00:00</span>
                </div>
                <div id="statusBadge" class="flex items-center gap-2 bg-slate-50 px-3 py-2 rounded-xl">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-tighter">Database Online</span>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="flex bg-slate-200/50 p-1.5 rounded-2xl mb-4 overflow-x-auto no-scrollbar gap-1">
            <button onclick="switchMode('beban')" id="tabBeban" class="flex-1 min-w-[100px] py-3.5 rounded-xl text-[10px] font-bold transition-all tab-active uppercase">Beban</button>
            <button onclick="switchMode('harian')" id="tabHarian" class="flex-1 min-w-[100px] py-3.5 rounded-xl text-[10px] font-bold transition-all text-slate-500 uppercase">Jadwal</button>
            <button onclick="switchMode('profil')" id="tabProfil" class="flex-1 min-w-[100px] py-3.5 rounded-xl text-[10px] font-bold transition-all text-slate-500 uppercase">Profil</button>
        </div>

        <!-- Profil View -->
        <div id="profilContent" class="hidden">
            <div id="profilGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
        </div>

        <!-- Table View -->
        <div id="tableView" class="space-y-3">
            <div id="filterControls" class="flex flex-col gap-2">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Cari..." class="w-full p-4 bg-white border-2 border-transparent focus:border-blue-500 rounded-[1.5rem] font-bold shadow-sm outline-none text-sm transition-all pr-12">
                    <div class="absolute right-4 top-4 text-slate-300">üîç</div>
                </div>
                <div id="daySelector" class="hidden">
                    <select id="currentDay" class="w-full p-4 bg-blue-600 text-white font-black rounded-[1.5rem] shadow-lg outline-none text-sm appearance-none text-center">
                        <option value="SENIN">üìÖ SENIN</option>
                        <option value="SELASA">üìÖ SELASA</option>
                        <option value="RABU">üìÖ RABU</option>
                        <option value="KAMIS">üìÖ KAMIS</option>
                        <option value="JUMAT">üìÖ JUMAT</option>
                    </select>
                </div>
            </div>

            <div class="bg-white rounded-[2rem] shadow-xl border border-slate-100 overflow-hidden relative">
                <div class="table-container overflow-x-auto" style="max-height: 55vh;">
                    <table class="w-full text-left border-collapse min-w-full">
                        <thead id="tableHead" class="bg-slate-900 text-white text-[9px] font-black uppercase header-sticky"></thead>
                        <tbody id="tableBody" class="divide-y divide-slate-50 text-[11px] font-bold text-slate-600"></tbody>
                    </table>
                </div>
                <div id="loadingStatus" class="hidden py-12 text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-600 border-t-transparent mb-2"></div>
                    <p class="text-xs font-bold text-slate-400">Sinkronisasi Database...</p>
                </div>
                <div id="emptyState" class="hidden py-12 text-center">
                    <span class="text-4xl block mb-2">ü§∑‚Äç‚ôÇÔ∏è</span>
                    <p class="text-xs font-bold text-slate-400">Data tidak ditemukan.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DB_BEBAN_ID = '1t3WNhu2tCaHWPTNcyOC7kupXNNdE6pH30QRAqyr1L8s';
        const DB_HARIAN_ID = '16KRfWyLgC-NUWfTaAbFJScvYVJPeVYTMKoGVUS1pcZw';
        
        const GIDS = {
            BEBAN: '1034481041', PTK: '482225314', REF: '2095410455',
            SENIN: '839984198', SELASA: '916529932', RABU: '169960223', KAMIS: '1132074708', JUMAT: '850141657'
        };

        let currentUser = { name: '', role: 'guru', guruCode: '', isAdmin: false };
        let viewMode = 'beban';

        function updateClock() {
            const now = new Date();
            document.getElementById('displayTime').textContent = now.toLocaleTimeString('id-ID', {hour12:false});
            const days = ['MINGGU','SENIN','SELASA','RABU','KAMIS','JUMAT','SABTU'];
            const months = ['JAN','FEB','MAR','APR','MEI','JUN','JUL','AGU','SEP','OKT','NOV','DES'];
            document.getElementById('displayDate').textContent = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} 2026`;
            
            const statusBadge = document.getElementById('statusBadge');
            if(navigator.onLine) {
                statusBadge.innerHTML = `<span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span><span class="text-[9px] font-black text-slate-500 uppercase">Database Online</span>`;
            } else {
                statusBadge.innerHTML = `<span class="w-2 h-2 bg-red-500 rounded-full"></span><span class="text-[9px] font-black text-red-500 uppercase">Mode Offline</span>`;
            }
        }

        window.onload = () => {
            const saved = localStorage.getItem('smapan_user');
            if(saved) {
                const data = JSON.parse(saved);
                initApp(data.role, data.name);
            }
            setInterval(updateClock, 1000);
            updateClock();
        };

        async function initApp(role, name) {
            currentUser.role = role;
            currentUser.name = name;
            currentUser.isAdmin = (role === 'admin');
            
            localStorage.setItem('smapan_user', JSON.stringify({role, name}));
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            document.getElementById('appTitle').textContent = currentUser.isAdmin ? 'Master Administrator' : name;
            document.getElementById('userStatus').textContent = currentUser.isAdmin ? 'MASTER ADMIN' : 'GURU SMAPANMU';
            
            if(currentUser.isAdmin) {
                document.getElementById('adminControls').classList.remove('hidden');
                document.getElementById('userCodes').textContent = 'ADMIN';
            } else {
                await fetchRefAndIdentify();
            }
            
            fetchContent();
        }

        async function fetchRefAndIdentify() {
            try {
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${DB_HARIAN_ID}/export?format=csv&gid=${GIDS.REF}`);
                const csv = await res.text();
                const lines = csv.split('\n').map(l => parseCSV(l));
                const match = lines.find(r => r[12]?.toLowerCase().trim() === currentUser.name.toLowerCase().trim());
                if(match) {
                    currentUser.guruCode = match[11];
                    document.getElementById('userCodes').textContent = currentUser.guruCode;
                }
            } catch (e) { 
                document.getElementById('userCodes').textContent = 'ERR';
            }
        }

        function switchMode(mode) {
            viewMode = mode;
            document.querySelectorAll('[id^="tab"]').forEach(el => {
                el.classList.remove('tab-active');
                el.classList.add('text-slate-500');
            });
            document.getElementById('tab' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('tab-active');
            
            document.getElementById('tableView').classList.toggle('hidden', mode === 'profil');
            document.getElementById('profilContent').classList.toggle('hidden', mode !== 'profil');
            document.getElementById('daySelector').classList.toggle('hidden', mode !== 'harian');
            
            fetchContent();
        }

        function openMasterDatabase() {
            const sid = viewMode === 'harian' ? DB_HARIAN_ID : DB_BEBAN_ID;
            window.open(`https://docs.google.com/spreadsheets/d/${sid}/edit`, '_blank');
        }

        async function fetchContent() {
            const loading = document.getElementById('loadingStatus');
            const empty = document.getElementById('emptyState');
            loading.classList.remove('hidden');
            empty.classList.add('hidden');

            let url = '';
            const day = document.getElementById('currentDay').value;
            
            if(viewMode === 'beban') url = `https://docs.google.com/spreadsheets/d/${DB_BEBAN_ID}/export?format=csv&gid=${GIDS.BEBAN}`;
            else if(viewMode === 'harian') url = `https://docs.google.com/spreadsheets/d/${DB_HARIAN_ID}/export?format=csv&gid=${GIDS[day]}`;
            else if(viewMode === 'profil') url = `https://docs.google.com/spreadsheets/d/${DB_BEBAN_ID}/export?format=csv&gid=${GIDS.PTK}`;

            try {
                const res = await fetch(url);
                const csv = await res.text();
                loading.classList.add('hidden');
                if(viewMode === 'profil') renderProfil(csv); else renderTable(csv);
            } catch (e) {
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }

        function renderProfil(csv) {
            const lines = csv.split('\n').map(l => parseCSV(l));
            const grid = document.getElementById('profilGrid');
            const headers = lines[0]; 
            const ptkData = lines.slice(1).find(r => r[1]?.toLowerCase().trim() === currentUser.name.toLowerCase().trim());
            
            if(!ptkData || currentUser.isAdmin) {
                grid.innerHTML = `<div class="col-span-full py-12 text-center font-bold text-slate-400 bg-white rounded-[2rem] border-2 border-dashed border-slate-100">${currentUser.isAdmin ? 'Data profil hanya tersedia untuk akun Guru.' : 'Profil tidak ditemukan.'}</div>`;
                return;
            }

            let profileHTML = '';
            headers.forEach((label, i) => {
                if(!label || i === 0) return;
                const value = ptkData[i] || '-';
                profileHTML += `
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-4 transition-all">
                        <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-xl shrink-0">üìÑ</div>
                        <div class="overflow-hidden">
                            <p class="text-[8px] font-black text-slate-300 uppercase tracking-widest mb-0.5">${label}</p>
                            <p class="text-xs font-bold text-slate-800 truncate">${value}</p>
                        </div>
                    </div>`;
            });
            grid.innerHTML = profileHTML;
        }

        function renderTable(csv) {
            const lines = csv.split('\n').map(l => parseCSV(l));
            const head = document.getElementById('tableHead');
            const body = document.getElementById('tableBody');
            
            if(viewMode === 'beban') {
                const headers = lines[8] || [];
                // Admin: Kolom utuh dari CSV. Guru: Mulai kolom Nama (index 2).
                const displayHeaders = currentUser.isAdmin ? headers : headers.slice(1);
                
                head.innerHTML = `<tr><th class="p-4 sticky-col bg-slate-900 border-r border-slate-800">#</th>${displayHeaders.map(h => `<th class="p-4 min-w-[140px] text-center">${h}</th>`).join('')}</tr>`;
                
                let rows = lines.slice(9);
                if(!currentUser.isAdmin) {
                    rows = rows.filter(r => r[2]?.toLowerCase().includes(currentUser.name.toLowerCase()));
                }
                
                body.innerHTML = rows.map((r,i) => {
                    const rowData = currentUser.isAdmin ? r : r.slice(1);
                    return `<tr><td class="p-4 sticky-col bg-white border-r text-center font-black text-slate-300">${i+1}</td>${rowData.map(c => `<td class="p-4 whitespace-nowrap text-center">${c || '-'}</td>`).join('')}</tr>`;
                }).join('');

            } else {
                const times = lines[1] || [];
                head.innerHTML = `<tr><th class="p-4 sticky-col bg-slate-900 border-r border-slate-800">KELAS</th>${times.slice(1).map(t => `<th class="p-4 text-center min-w-[90px]">${t}</th>`).join('')}</tr>`;
                
                let rows = lines.slice(2);
                if(!currentUser.isAdmin && currentUser.guruCode) {
                    rows = rows.filter(r => r.some(c => c.endsWith(`.${currentUser.guruCode}`)));
                }

                body.innerHTML = rows.map(r => `<tr><td class="p-4 sticky-col bg-white font-black text-blue-900 border-r shadow-sm">${r[0]}</td>${r.slice(1).map(c => {
                    const isMe = !currentUser.isAdmin && currentUser.guruCode && c.endsWith(`.${currentUser.guruCode}`);
                    const hasContent = c && c !== '-';
                    return `<td class="p-2"><div class="${isMe?'my-schedule-cell text-center flex flex-col justify-center min-h-[44px]':(hasContent?'text-center font-extrabold text-slate-600 text-[10px] uppercase':'text-center text-slate-200')}">${c||'-'}</div></td>`;
                }).join('')}</tr>`).join('');
            }
            document.getElementById('emptyState').classList.toggle('hidden', body.children.length > 0);
        }

        function parseCSV(row) {
            if (!row) return [];
            const res = []; let c = '', q = false;
            for (let char of row) {
                if(char === '"') q = !q;
                else if(char === ',' && !q) { res.push(c.trim()); c = ''; }
                else c += char;
            }
            res.push(c.trim());
            return res;
        }

        function toggleLoginInput() {
            const role = document.getElementById('loginRole').value;
            document.getElementById('guruInputGroup').classList.toggle('hidden', role === 'admin');
            document.getElementById('adminInputGroup').classList.toggle('hidden', role === 'guru');
        }

        document.getElementById('btnEnter').onclick = () => {
            const role = document.getElementById('loginRole').value;
            if(role === 'admin') {
                if(document.getElementById('adminPassword').value === 'dani') initApp('admin', 'Administrator');
                else alert("Password admin salah!");
            } else {
                const name = document.getElementById('loginUsername').value;
                if(name.trim() !== "") initApp('guru', name);
                else alert("Masukkan nama!");
            }
        };

        document.getElementById('logoutBtn').onclick = () => {
            localStorage.removeItem('smapan_user');
            location.reload();
        };

        document.getElementById('currentDay').onchange = () => fetchContent();
        document.getElementById('searchInput').oninput = (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('#tableBody tr').forEach(tr => {
                tr.classList.toggle('hidden', !tr.innerText.toLowerCase().includes(term));
            });
        };
    </script>
</body>
</html>
