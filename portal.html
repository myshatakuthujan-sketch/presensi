<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portal Guru SMAPANMU</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="data:application/json;base64,ewogICJnameiOiAiUG9ydGFsIEd1cnUgU01BUEFOTVUiLAogICJzaG9ydF9uYW1lIjogIlNNQVBBTk1VIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmOGZhZmMiLAogICJ0aGVtZV9jb3VyIjogIiMxZTQwYWYiCn0=">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        
        :root { --primary: #1e40af; --accent: #3b82f6; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: radial-gradient(circle at top right, #f8fafc, #eff6ff);
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s cubic-bezier(0.76, 0, 0.24, 1) infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sticky-col { position: sticky; left: 0; background: #ffffff; z-index: 10; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .header-sticky { position: sticky; top: 0; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-active { background: white; color: #1e40af; box-shadow: 0 4px 12px rgba(0,0,0,0.08); font-weight: 700; }
        .sub-tab-active { background: #1e40af; color: white !important; font-weight: 700; border-color: #1e40af !important; }
        .btn-gradient { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); }
        .my-schedule-cell { background-color: #2563eb !important; color: white !important; font-weight: 800; border-radius: 0.5rem; padding: 6px 4px; min-width: 70px; font-size: 10px; }
        .no-select { user-select: none; -webkit-user-select: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @media (max-width: 640px) { .table-text { font-size: 9px !important; } }
        #syncBadge.syncing { background-color: #3b82f6; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="min-h-screen text-slate-900 pb-12">

    <!-- Offline Indicator -->
    <div id="offlineToast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[2000] hidden">
        <div class="bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3">
            <span class="w-2 h-2 bg-red-500 rounded-full animate-ping"></span>
            <span class="text-[10px] font-bold uppercase tracking-widest">Mode Offline</span>
        </div>
    </div>

    <!-- Login Overlay -->
    <div id="loginOverlay" class="fixed inset-0 z-[1000] bg-slate-900/50 backdrop-blur-xl flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden">
            <div class="p-8 text-center bg-gradient-to-br from-blue-700 to-blue-900 text-white">
                <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi2iWi5Y8Dt91tWD8v24sfYGNL9jWxhRp2epChSaav1QQ3CZWhRb753XFGQOsT9u82kEEQAVkdZVKbbQ2I4Tkhkr9h00KJkaYnZK3jI-HPuUqcO6A3UXFZ9l43qF0sajMqs5asm2ttdvjYUxsxswINcBf7bN7gcNooq-R0KVSFwirkTeTICe6cTnGlyPmQ/s1600/logo%20mapan.png" class="h-16 mx-auto mb-4">
                <h2 class="text-xl font-extrabold uppercase tracking-tight">PORTAL GURU</h2>
                <p class="text-blue-100/70 text-[10px] uppercase font-bold tracking-widest">SMAPANMU System</p>
            </div>
            <div class="p-8 space-y-5">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Hak Akses</label>
                    <select id="loginRole" onchange="toggleLoginInput()" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl font-bold focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="guru">üë§ GURU (PERSONAL)</option>
                        <option value="admin">üîë ADMIN (PENGELOLA)</option>
                    </select>
                </div>
                <div id="guruInputGroup">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Nama Lengkap</label>
                    <input type="text" id="loginUsername" placeholder="Ketik nama sesuai database..." class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="adminInputGroup" class="hidden">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Password</label>
                    <input type="password" id="adminPassword" placeholder="Password admin..." class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="btnEnter" class="w-full btn-gradient text-white py-4 rounded-2xl font-bold shadow-xl active:scale-95 transition-transform uppercase tracking-wider">Masuk</button>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden max-w-7xl mx-auto px-4 py-6">
        <!-- Profile Header -->
        <div class="mb-6 glass-card p-5 md:p-6 rounded-[2rem] shadow-sm">
            <div class="flex items-center gap-4 mb-5">
                <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi2iWi5Y8Dt91tWD8v24sfYGNL9jWxhRp2epChSaav1QQ3CZWhRb753XFGQOsT9u82kEEQAVkdZVKbbQ2I4Tkhkr9h00KJkaYnZK3jI-HPuUqcO6A3UXFZ9l43qF0sajMqs5asm2ttdvjYUxsxswINcBf7bN7gcNooq-R0KVSFwirkTeTICe6cTnGlyPmQ/s1600/logo%20mapan.png" class="h-10 md:h-12 w-auto">
                <div class="flex-1">
                    <h1 id="appTitle" class="text-lg md:text-xl font-bold text-slate-900 leading-tight">Portal Guru</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <p id="userStatus" class="text-[9px] md:text-[10px] text-slate-500 font-bold uppercase"></p>
                        <span id="userCodes" class="text-[8px] md:text-[9px] bg-blue-50 text-blue-700 px-2 py-0.5 rounded font-black"></span>
                        <span id="syncBadge" class="text-[7px] bg-slate-100 text-slate-400 px-1.5 py-0.5 rounded font-black uppercase tracking-tighter transition-colors">Auto-Sync ON</span>
                    </div>
                </div>
                <button id="logoutBtn" class="bg-red-50 p-2.5 rounded-xl text-red-500 hover:bg-red-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                </button>
            </div>

            <div class="flex items-center justify-between pt-4 border-t border-slate-100">
                <div class="flex flex-col">
                    <span id="displayDate" class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Memuat...</span>
                    <span id="displayTime" class="text-xl md:text-2xl font-black text-slate-900">00:00:00</span>
                </div>
                <div id="adminControls" class="hidden flex items-center gap-2">
                    <button onclick="openMasterDatabase()" class="bg-orange-500 text-white px-3 py-2.5 md:px-4 md:py-3 rounded-xl text-[9px] md:text-[10px] font-black uppercase shadow-lg shadow-orange-100 active:scale-95 transition-transform">DATABASE</button>
                </div>
            </div>
        </div>

        <!-- Main Nav Tabs -->
        <div class="flex bg-slate-200/50 p-1.5 rounded-2xl mb-4 overflow-x-auto no-scrollbar scroll-smooth">
            <button onclick="switchMode('beban')" id="tabBeban" class="flex-none px-5 py-3.5 rounded-xl text-[11px] md:text-xs font-bold transition-all tab-active uppercase whitespace-nowrap">üìã Beban Ajar</button>
            <button onclick="switchMode('harian')" id="tabHarian" class="flex-none px-5 py-3.5 rounded-xl text-[11px] md:text-xs font-bold transition-all text-slate-500 uppercase whitespace-nowrap">üóìÔ∏è Jadwal</button>
            <button onclick="switchMode('profil')" id="tabProfil" class="hidden flex-none px-5 py-3.5 rounded-xl text-[11px] md:text-xs font-bold transition-all text-slate-500 uppercase whitespace-nowrap">üë§ Profil Saya</button>
            <button onclick="switchMode('dapodik', 'DAP_PTK')" id="tabDapodik" class="hidden flex-none px-5 py-3.5 rounded-xl text-[11px] md:text-xs font-bold transition-all text-slate-500 uppercase whitespace-nowrap">üìÇ Dapodik</button>
        </div>

        <!-- Dapodik Sub-Tabs -->
        <div id="dapodikSubTabs" class="hidden flex gap-2 mb-6 overflow-x-auto no-scrollbar pb-2 px-1">
            <button onclick="switchMode('dapodik', 'DAP_IDENTITAS')" id="sub_DAP_IDENTITAS" class="flex-none px-4 py-2.5 rounded-lg text-[9px] font-bold bg-white border border-slate-200 text-slate-600 uppercase whitespace-nowrap">Identitas</button>
            <button onclick="switchMode('dapodik', 'DAP_PTK')" id="sub_DAP_PTK" class="flex-none px-4 py-2.5 rounded-lg text-[9px] font-bold bg-white border border-slate-200 text-slate-600 uppercase whitespace-nowrap font-black border-blue-500">Guru/PTK</button>
            <button onclick="switchMode('dapodik', 'DAP_SISWA')" id="sub_DAP_SISWA" class="flex-none px-4 py-2.5 rounded-lg text-[9px] font-bold bg-white border border-slate-200 text-slate-600 uppercase whitespace-nowrap">Siswa</button>
            <button onclick="switchMode('dapodik', 'DAP_ROMBEL')" id="sub_DAP_ROMBEL" class="flex-none px-4 py-2.5 rounded-lg text-[9px] font-bold bg-white border border-slate-200 text-slate-600 uppercase whitespace-nowrap">Rombel</button>
            <button onclick="switchMode('dapodik', 'DAP_JADWAL')" id="sub_DAP_JADWAL" class="flex-none px-4 py-2.5 rounded-lg text-[9px] font-bold bg-white border border-slate-200 text-slate-600 uppercase whitespace-nowrap">Jadwal</button>
            <button onclick="switchMode('dapodik', 'DAP_SARPRAS')" id="sub_DAP_SARPRAS" class="flex-none px-4 py-2.5 rounded-lg text-[9px] font-bold bg-white border border-slate-200 text-slate-600 uppercase whitespace-nowrap">Sarpras</button>
            <button onclick="switchMode('dapodik', 'DAP_NILAI')" id="sub_DAP_NILAI" class="flex-none px-4 py-2.5 rounded-lg text-[9px] font-bold bg-white border border-slate-200 text-slate-600 uppercase whitespace-nowrap">Nilai</button>
            <button onclick="switchMode('dapodik', 'DAP_REKAP')" id="sub_DAP_REKAP" class="flex-none px-4 py-2.5 rounded-lg text-[9px] font-bold bg-white border border-slate-200 text-slate-600 uppercase whitespace-nowrap">Rekap</button>
        </div>

        <!-- Search & Filter Area -->
        <div id="filterControls" class="flex flex-col gap-4 mb-6">
            <div class="relative group">
                <input type="text" id="searchInput" placeholder="Cari data..." class="w-full pl-11 pr-4 py-4 bg-white border border-slate-200 rounded-2xl font-bold shadow-sm focus:ring-4 focus:ring-blue-100 transition-all outline-none text-sm">
                <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>
            </div>
            
            <div id="daySelector" class="hidden relative">
                <select id="currentDay" class="w-full p-4 bg-blue-600 text-white font-black rounded-2xl shadow-lg appearance-none outline-none text-sm tracking-widest">
                    <option value="SENIN">SENIN</option><option value="SELASA">SELASA</option><option value="RABU">RABU</option><option value="KAMIS">KAMIS</option><option value="JUMAT">JUMAT</option>
                </select>
                <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-white/50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7" /></svg>
                </div>
            </div>
        </div>

        <!-- Profil Content -->
        <div id="profilContent" class="hidden space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="profilDetails">
                <!-- Biodata rows injected via JS -->
            </div>
        </div>

        <!-- Main Table View -->
        <div id="tableView" class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-100 overflow-hidden relative">
            <div class="overflow-x-auto no-select no-scrollbar" style="max-height: 65vh;">
                <table class="w-full text-left border-collapse min-w-[800px]">
                    <thead id="tableHead" class="bg-slate-900 text-white text-[9px] md:text-[10px] font-black uppercase header-sticky"></thead>
                    <tbody id="tableBody" class="divide-y divide-slate-50 text-[10px] md:text-[11px] font-medium text-slate-600 table-text"></tbody>
                </table>
            </div>
            <div id="loadingStatus" class="absolute inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-[50] hidden">
                <div class="loader mb-4"></div>
                <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Memuat...</span>
            </div>
            <div id="emptyState" class="hidden py-20 text-center text-slate-300 font-black uppercase text-[10px] tracking-widest">Data tidak ditemukan.</div>
        </div>
    </div>

    <script>
        const DB_BEBAN_ID = '1t3WNhu2tCaHWPTNcyOC7kupXNNdE6pH30QRAqyr1L8s';
        const DB_HARIAN_ID = '16KRfWyLgC-NUWfTaAbFJScvYVJPeVYTMKoGVUS1pcZw';
        const DB_DAP_CORE = '1KVkzy7IjxDrxxWhMQjSsLK8uQ_oEYjJSbm5snTPxeqo';
        const DB_DAP_NILAI = '1wMA4Q5EDmoPxyYiA7NHDdi42uPLJ1iaFhzZ1-yqt2dI';
        const DB_DAP_REKAP = '1RU_mA4xV4pmZibeBbbgotcj09WWBoYeT13Hx7T0XX_4';

        const GIDS = { 
            BEBAN: '1034481041', REF: '2095410455', 
            SENIN: '839984198', SELASA: '916529932', RABU: '169960223', KAMIS: '1132074708', JUMAT: '850141657',
            DAP_IDENTITAS: { id: DB_DAP_CORE, gid: '1205239446' },
            DAP_PTK: { id: DB_DAP_CORE, gid: '2037943441' },
            DAP_SISWA: { id: DB_DAP_CORE, gid: '1887693900' },
            DAP_SARPRAS: { id: DB_DAP_CORE, gid: '315509224' },
            DAP_ROMBEL: { id: DB_DAP_CORE, gid: '2135637764' },
            DAP_JADWAL: { id: DB_DAP_CORE, gid: '114459892' },
            DAP_NILAI: { id: DB_DAP_NILAI, gid: '2065757027' },
            DAP_REKAP: { id: DB_DAP_REKAP, gid: '275467067' }
        };

        const ADMIN_PASS = 'dani';
        let viewMode = 'beban';
        let subMode = '';
        let currentUser = { role: null, name: null, guruCode: null };
        let allRefData = [];
        let autoSyncTimer = null;

        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('smapanmu_user');
            if (saved) performLogin(JSON.parse(saved).role, JSON.parse(saved).name, true);
            setInterval(updateClock, 1000);
            updateClock();
            startAutoSync();
            window.addEventListener('online', toggleOfflineUI);
            window.addEventListener('offline', toggleOfflineUI);
            toggleOfflineUI();
        });

        function toggleOfflineUI() {
            const isOffline = !navigator.onLine;
            document.getElementById('offlineToast').classList.toggle('hidden', !isOffline);
        }

        function updateClock() {
            const now = new Date();
            const days = ['MINGGU', 'SENIN', 'SELASA', 'RABU', 'KAMIS', 'JUMAT', 'SABTU'];
            const months = ['JAN', 'FEB', 'MAR', 'APR', 'MEI', 'JUN', 'JUL', 'AGU', 'SEP', 'OKT', 'NOV', 'DES'];
            document.getElementById('displayTime').textContent = now.toLocaleTimeString('id-ID', { hour12: false });
            document.getElementById('displayDate').textContent = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
        }

        function startAutoSync() {
            if(autoSyncTimer) clearInterval(autoSyncTimer);
            autoSyncTimer = setInterval(() => {
                if(document.getElementById('mainApp').classList.contains('hidden') || !navigator.onLine) return;
                fetchContent(true);
            }, 300000);
        }

        async function performLogin(role, name, isAuto = false) {
            if (role === 'guru' && !name) return;
            currentUser = { role, name };
            if(!isAuto) localStorage.setItem('smapanmu_user', JSON.stringify({ role, name }));
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            if (role === 'admin') {
                document.getElementById('adminControls').classList.remove('hidden');
                document.getElementById('tabDapodik').classList.remove('hidden');
                document.getElementById('tabProfil').classList.add('hidden');
            } else {
                document.getElementById('adminControls').classList.add('hidden');
                document.getElementById('tabDapodik').classList.add('hidden');
                document.getElementById('tabProfil').classList.remove('hidden');
            }
            
            await fetchReferences();
            identifyUser();
            updateHeader();
            fetchContent();
        }

        function toggleLoginInput() {
            const role = document.getElementById('loginRole').value;
            document.getElementById('guruInputGroup').classList.toggle('hidden', role === 'admin');
            document.getElementById('adminInputGroup').classList.toggle('hidden', role === 'guru');
        }

        document.getElementById('btnEnter').addEventListener('click', () => {
            const role = document.getElementById('loginRole').value;
            if (role === 'admin') {
                if (document.getElementById('adminPassword').value === ADMIN_PASS) performLogin('admin', 'Admin');
                else alert('Password Salah');
            } else {
                const name = document.getElementById('loginUsername').value;
                if(name) performLogin('guru', name);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('smapanmu_user');
            location.reload();
        });

        async function fetchReferences() {
            const cacheKey = 'cache_ref';
            try {
                if(!navigator.onLine) throw "Offline";
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${DB_HARIAN_ID}/export?format=csv&gid=${GIDS.REF}&t=${Date.now()}`);
                const csv = await res.text();
                localStorage.setItem(cacheKey, csv);
                allRefData = csv.split(/\r?\n/).map(row => parseCSV(row));
            } catch (e) { 
                const cached = localStorage.getItem(cacheKey);
                if(cached) allRefData = cached.split(/\r?\n/).map(row => parseCSV(row));
            }
        }

        function identifyUser() {
            if(currentUser.role !== 'guru') return;
            const match = allRefData.find(r => r[12]?.toLowerCase() === currentUser.name.toLowerCase());
            if(match) currentUser.guruCode = match[11];
        }

        function updateHeader() {
            document.getElementById('appTitle').textContent = currentUser.name;
            document.getElementById('userStatus').textContent = currentUser.role === 'admin' ? "System Administrator" : "Guru SMAPANMU";
            document.getElementById('userCodes').textContent = currentUser.guruCode || (currentUser.role === 'admin' ? "ROOT" : "N/A");
        }

        function switchMode(mode, sub = '') {
            viewMode = mode;
            subMode = sub;

            document.querySelectorAll('[id^="tab"]').forEach(el => {
                el.classList.remove('tab-active');
                el.classList.add('text-slate-500');
            });
            
            const activeTab = document.getElementById('tab' + mode.charAt(0).toUpperCase() + mode.slice(1));
            if(activeTab) {
                activeTab.classList.add('tab-active');
                activeTab.classList.remove('text-slate-500');
            }

            document.getElementById('dapodikSubTabs').classList.toggle('hidden', mode !== 'dapodik');
            document.getElementById('daySelector').classList.toggle('hidden', mode !== 'harian');
            document.getElementById('filterControls').classList.toggle('hidden', mode === 'profil');
            document.getElementById('tableView').classList.toggle('hidden', mode === 'profil');
            document.getElementById('profilContent').classList.toggle('hidden', mode !== 'profil');

            fetchContent();
        }

        async function fetchContent(isSilent = false) {
            const load = document.getElementById('loadingStatus');
            if(!isSilent) load.classList.remove('hidden');
            
            let sid, gid, cacheKey;
            
            if(viewMode === 'beban') {
                sid = DB_BEBAN_ID; gid = GIDS.BEBAN; cacheKey = 'cache_beban';
            } else if(viewMode === 'harian') {
                const day = document.getElementById('currentDay').value;
                sid = DB_HARIAN_ID; gid = GIDS[day]; cacheKey = `cache_harian_${day}`;
            } else if(viewMode === 'profil') {
                sid = DB_DAP_CORE; gid = GIDS.DAP_PTK.gid; cacheKey = 'cache_profil';
            } else {
                sid = GIDS[subMode].id; gid = GIDS[subMode].gid; cacheKey = `cache_${subMode}`;
            }
            
            try {
                if(!navigator.onLine) throw "Offline";
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${sid}/export?format=csv&gid=${gid}&t=${Date.now()}`);
                const csv = await res.text();
                localStorage.setItem(cacheKey, csv);
                if(viewMode === 'profil') renderProfil(csv); else renderTable(csv);
            } catch (e) { 
                const cached = localStorage.getItem(cacheKey);
                if(cached) if(viewMode === 'profil') renderProfil(cached); else renderTable(cached);
            } finally { if(!isSilent) load.classList.add('hidden'); }
        }

        function renderProfil(csv) {
            const lines = csv.split(/\r?\n/).map(l => parseCSV(l));
            const headers = lines[0];
            // Filter berdasarkan Nama (kolom 0 di Dapodik Core - Guru/PTK)
            const profileData = lines.slice(1).find(r => r[0].toLowerCase().includes(currentUser.name.toLowerCase()));
            
            const container = document.getElementById('profilDetails');
            if (!profileData) {
                container.innerHTML = `<div class="col-span-full p-10 text-center font-bold text-slate-400">BIODATA TIDAK DITEMUKAN UNTUK NAMA: ${currentUser.name}</div>`;
                return;
            }

            // Pemetaan Kolom untuk Dapodik Core - Guru/PTK
            const fieldsToShow = [
                { icon: 'üë§', label: 'Nama Lengkap', index: 0 },
                { icon: 'üí≥', label: 'NUPTK', index: 1 },
                { icon: '‚öß', label: 'Jenis Kelamin', index: 2 },
                { icon: 'üìç', label: 'Tempat Lahir', index: 3 },
                { icon: 'üìÖ', label: 'Tanggal Lahir', index: 4 },
                { icon: 'üÜî', label: 'NIK', index: 5 },
                { icon: 'üè¢', label: 'Status Pegawai', index: 6 },
                { icon: '‚ö°', label: 'Jenis PTK', index: 7 },
                { icon: 'üéì', label: 'Pendidikan', index: 14 },
                { icon: 'üìú', label: 'SK Pengangkatan', index: 9 },
                { icon: 'üìÖ', label: 'TMT Pengangkatan', index: 10 },
                { icon: 'üìû', label: 'Nomor HP', index: 11 },
                { icon: 'üìß', label: 'Email', index: 12 }
            ];

            container.innerHTML = fieldsToShow.map(field => `
                <div class="bg-white p-5 rounded-[1.5rem] border border-slate-100 shadow-sm flex items-center gap-4 hover:border-blue-200 transition-all duration-300">
                    <div class="w-10 h-10 md:w-12 md:h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-lg md:text-xl shrink-0">${field.icon}</div>
                    <div class="overflow-hidden">
                        <p class="text-[8px] md:text-[9px] font-black text-slate-400 uppercase tracking-widest truncate">${field.label}</p>
                        <p class="text-xs md:text-sm font-bold text-slate-800 break-words">${profileData[field.index] || '-'}</p>
                    </div>
                </div>
            `).join('');
        }

        function renderTable(csv) {
            const lines = csv.split(/\r?\n/).map(l => parseCSV(l));
            const head = document.getElementById('tableHead');
            const body = document.getElementById('tableBody');
            
            if (viewMode === 'beban') {
                const headers = lines[8]?.slice(1, 23) || [];
                head.innerHTML = `<tr><th class="px-3 sticky-col bg-slate-900 border-r border-slate-800 text-center">#</th>${headers.map(h => `<th class="px-4 py-4 border-r border-slate-800 min-w-[120px]">${h}</th>`).join('')}</tr>`;
                let rows = lines.slice(9).filter(r => r[1] || r[2]);
                if(currentUser.role === 'guru') rows = rows.filter(r => r[2]?.toLowerCase().includes(currentUser.name.toLowerCase()));
                body.innerHTML = rows.map((r, i) => `<tr><td class="px-3 sticky-col bg-white border-r text-center font-bold text-slate-400">${i+1}</td>${r.slice(1, 23).map(c => `<td class="px-4 py-4 border-r whitespace-nowrap">${c || '-'}</td>`).join('')}</tr>`).join('');
            } else if (viewMode === 'harian') {
                const times = lines[1]?.slice(1, 14) || [];
                head.innerHTML = `<tr><th class="px-4 py-4 sticky-col bg-slate-900 border-r border-slate-800">KELAS</th>${times.map(t => `<th class="px-4 border-r border-slate-800 text-center min-w-[90px]">${t}</th>`).join('')}</tr>`;
                const rows = lines.slice(2).filter(r => r[0]);
                let filtered = rows;
                if(currentUser.role === 'guru' && currentUser.guruCode) filtered = rows.filter(r => r.slice(1, 14).some(cell => cell.endsWith(`.${currentUser.guruCode}`)));
                body.innerHTML = filtered.map(r => `<tr><td class="px-4 py-5 sticky-col bg-white border-r font-black text-blue-900">${r[0]}</td>${r.slice(1, 14).map(c => {
                    const isMe = currentUser.guruCode && c.endsWith(`.${currentUser.guruCode}`);
                    return `<td class="px-1 py-1 border-r"><div class="${isMe ? 'my-schedule-cell' : 'py-3 text-center'}">${c || '-'}</div></td>`;
                }).join('')}</tr>`).join('');
            } else {
                const headers = lines[0] || [];
                head.innerHTML = `<tr><th class="px-3 sticky-col bg-slate-900 border-r border-slate-800 text-center">#</th>${headers.map(h => `<th class="px-4 py-4 border-r border-slate-800 min-w-[140px]">${h}</th>`).join('')}</tr>`;
                const rows = lines.slice(1).filter(r => r.join('').trim() !== '');
                body.innerHTML = rows.map((r, i) => `<tr><td class="px-3 sticky-col bg-white border-r text-center font-bold text-slate-400">${i+1}</td>${r.map(c => `<td class="px-4 py-4 border-r whitespace-nowrap">${c || '-'}</td>`).join('')}</tr>`).join('');
            }
            document.getElementById('emptyState').classList.toggle('hidden', body.children.length > 0);
        }

        function parseCSV(row) {
            const res = []; let c = '', q = false;
            for (let char of row) {
                if(char === '"') q = !q;
                else if(char === ',' && !q) { res.push(c.trim()); c = ''; }
                else c += char;
            }
            res.push(c.trim());
            return res;
        }

        document.getElementById('currentDay').addEventListener('change', () => fetchContent());
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(r => r.classList.toggle('hidden', !r.innerText.toLowerCase().includes(term)));
        });

        function openMasterDatabase() {
            if(!navigator.onLine) return alert('Fitur ini memerlukan koneksi internet.');
            const sid = viewMode === 'beban' ? DB_BEBAN_ID : (viewMode === 'harian' ? DB_HARIAN_ID : GIDS[subMode].id);
            window.open(`https://docs.google.com/spreadsheets/d/${sid}/edit`, '_blank');
        }
    </script>
</body>
</html>
